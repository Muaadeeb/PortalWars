@using PortalWars.Web.Data

<div class="parchment-card party-card party-card-toggle" aria-expanded="@_isOpen">
    <button type="button"
            class="party-card-header"
            @onclick="Toggle"
            aria-expanded="@_isOpen">
        <div class="d-flex align-items-start gap-3 w-100">
            <div class="portrait">
                @if (!string.IsNullOrWhiteSpace(Member.PortraitUrl))
                {
                    <img src="@Member.PortraitUrl" alt="@Member.Name portrait" />
                }
                else
                {
                    <div class="portrait-placeholder">@Member.Name.Substring(0, 1)</div>
                }
            </div>

            <div class="flex-grow-1 text-start">
                <div class="d-flex flex-wrap align-items-baseline gap-2">
                    <h2 class="party-name m-0">@Member.Name</h2>
                    <span class="party-meta">@Member.Race • @Member.Class@if (!string.IsNullOrWhiteSpace(Member.Archetype))
                        {
                            <text> (@Member.Archetype)</text>
                        }
                    </span>
                    <span class="party-level">Lv @Member.Level</span>
                </div>

                @if (!string.IsNullOrWhiteSpace(Member.Hook))
                {
                    <div class="party-hook mt-2">@Member.Hook</div>
                }

                <div class="mt-3 d-flex flex-wrap gap-2">
                    @if (Member.Vitals?.AC is not null)
                    {
                        <span class="tag-pill">AC: @Member.Vitals.AC</span>
                    }
                    @if (Member.Vitals?.HP is not null)
                    {
                        <span class="tag-pill">HP: @Member.Vitals.HP</span>
                    }
                    @if (Member.Vitals?.Perception is not null)
                    {
                        <span class="tag-pill">Perception: @Member.Vitals.Perception</span>
                    }
                </div>
            </div>

            <div class="party-chevron" aria-hidden="true">
                <span>@(_isOpen ? "▾" : "▸")</span>
            </div>
        </div>
    </button>

    <div class="party-card-body @(_isOpen ? "open" : "")">
        <div class="party-card-body-inner">
            <div class="glow-divider"></div>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="party-detail">
                        <div class="party-detail-label">Alignment</div>
                        <div class="party-detail-value">@OrDash(Member.Alignment)</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="party-detail">
                        <div class="party-detail-label">Deity / Philosophy</div>
                        <div class="party-detail-value">@OrDash(Member.DeityOrPhilosophy)</div>
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(Member.SignatureItem) && Member.SignatureItem != "—")
                {
                    <div class="col-12">
                        <div class="party-signature">
                            <span class="party-signature-label">Signature:</span> @Member.SignatureItem
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter, EditorRequired] public PartyMember Member { get; set; } = default!;

    [Parameter] public bool DefaultOpen { get; set; } = false;

    private bool _isOpen;

    protected override void OnInitialized()
    {
        _isOpen = DefaultOpen;
    }

    private void Toggle() => _isOpen = !_isOpen;

    private static string OrDash(string? s)
        => string.IsNullOrWhiteSpace(s) || s == "—" ? "—" : s;
}
